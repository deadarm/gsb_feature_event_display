<?php
/**
 * @file
 * Code for the GSB Feature Event Display feature.
 */

include_once 'gsb_feature_event_display.features.inc';

/**
 * Implements hook_ctools_plugin_directory().
 */
function gsb_feature_event_display_ctools_plugin_directory($module, $plugin) {
 if ($module == 'ctools' && !empty($plugin)) {
   return "plugins/$plugin";
 }
}

/**
 * Implementation of hook_form_FORM_ID_alter()
 *
 * Provides customizations to the views content type settings form
 */
function gsb_feature_event_display_form_views_content_views_panes_content_type_edit_form_alter(&$form, &$form_state, $form_id) {
  // Remove the default value for upcoming events.
  if (in_array($form_state['subtype_name'], array('gsb_event-upcoming_events'))) {
   // $form['content_settings']['view_mode']['#default_value'] = '';
    //---------
    $view_modes = $form['view_mode']['#options'];
    foreach($view_modes as $key=>$value) {
      if($key !== 'compact' AND $key !== 'expanded'){
        unset($form['view_mode']['#options'][$key]);
      }
    }
    $conf = $form_state['conf'];
    $title_link_default_value = '';
    if (!empty($conf['title_link'])) {
      $title_link_default_value = $conf['title_link'];
    }
    else if (!empty($conf['exposed']['title_link'])) {
      $title_link_default_value = $conf['exposed']['title_link'];
    }
    $form['exposed']['arguments']['#weight'] = 90;
    $item['title_link'] = array(
      '#title' => t('URL'),
      '#type' => 'textfield',
      '#weight' => -99,
      '#default_value' => !empty($conf['title_link']) ? $conf['title_link'] : '',
    );
    $form['override_title']['#weight'] = -99;
    $form['items_per_page']['#weight'] = -98;
    $form['view_mode']['#weight'] = -98;
    $form['exposed']['#weight'] = -97;
    $form = gsb_misc_fixes_associative_insert($form, 'override_title_text', $item);
    $form['comments']['#access'] = FALSE;
    $form['links']['#access'] = FALSE;
//-----------
  }

  if (isset($form["display_settings"])) {
    if (isset($form["display_settings"]["view_settings"])) {
      $form["display_settings"]["view_settings"]['#access'] = FALSE;
    }
    if (isset($form["display_settings"]["header_type"])) {
      $form["display_settings"]["header_type"]['#access'] = FALSE;
    }
  }
  if (isset($form["content_settings"])) {
    $form["content_settings"]['#access'] = FALSE;
  }
}

/**
 * Implementation of hook_module_implements_alter()
 */
function gsb_feature_event_display_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter') {
    if (isset($implementations['gsb_feature_event_display'])) {
      $group = $implementations['gsb_feature_event_display'];
      unset($implementations['gsb_feature_event_display']);
      $implementations['gsb_feature_event_display'] = $group;
    }
  }
}

/**
 * Implements hook_field_extra_fields().
 */
function gsb_feature_event_display_field_extra_fields() {
  $extra = array();
  // Add an extra field for iCal links.
  $extra['node']['event']['display']['gsb_feature_event_display_ical'] = array(
    'label' => t('iCal URL'),
    'description' => t('A link to an iCal event'),
    'weight' => 0,
  );
  return $extra;
}

/**
 * Implements hook_node_view().
 */
function gsb_feature_event_display_node_view($node, $view_mode, $langcode) {
  // Only process events.
  if ($node->type != 'event') {
    return;
  }

  // Add a link for the iCal event.
  $node->content['gsb_feature_event_display_ical'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'event-ical-link',
      ),
    ),
    'link' => array(
      '#type' => 'link',
      '#title' => t('Add to My Calendar'),
      '#href' => 'events/ical/' . $node->nid . '/event.ics',
      '#attributes' => array(
        'class' => array(
          'green-rounded-button',
        ),
      ),
    ),
  );
}

/**
 * Implements hook_preprocess_HOOK() for node.tpl.php.
 */
function gsb_feature_event_display_preprocess_node(&$variables) {
  // Give the event listing the same class as teaser to trick the CSS.
  if ($variables['type'] == 'event' && $variables['view_mode'] == 'event_listing') {
    $variables['classes_array'][] = 'view-mode-teaser';
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for views_exposed_form().
 */
function gsb_feature_event_display_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {

  if ($form_state['view']->name == 'gsb_event') {

    $form['#attached']['js'][] = drupal_get_path('module', 'gsb_feature_event_display') . '/js/gsb_feature_event_display.views.js';

    // Remove the ' Admissions' suffix from admissions options.
//    foreach ($form['admissions']['#options'] as &$option) {
//      $option = str_replace(' Admissions', '', $option);
//    }
  }
  elseif ($form_state['view']->name == 'admission_events') {

    // Directly manipulate the exposed sorts to work with clicksort.
    if (isset($_GET['sort_order']) && !isset($_GET['order'])) {
      $_GET['sort'] = $_GET['sort_order'];
      $_GET['order'] = 'field_event_date_value';
    }

    $form['#attributes']['class'][] = 'exposed_filter_widget';
    $form['#attributes']['class'][] = 'exposed_filter_widget_one_column';

    $form['#attached']['js'][] = drupal_get_path('module', 'gsb_feature_event_display') . '/js/gsb_feature_event_display.views.js';
    $form['#attached']['js'][] = array(
      'type' => 'setting',
      'data' => array(
        'gsb_feature_event_display' => array(
          'admission_event_active' => (isset($_GET['date_op']) && $_GET['date_op'] == '<') ? 'past' : 'upcoming',
        ),
      ),
    );
    // Force the form to always sort by date.
    $form['sort_by'] = array(
      '#type' => 'value',
      '#value' => 'field_event_date_value',
    );
    // Prevent the date value from being exposed.
    $form['date'] = array('#type' => 'value');

    // Submit field_department_tid value from Pane settings.
    $form['field_department_tid'] = array(
      '#type' => 'hidden',
      '#value' => $form_state['input']['field_department_tid'],
    );
  }
}

function gsb_feature_event_display_gsb_fpp_customizations_icons_alter(&$icons) {
  $module_path = drupal_get_path('module', 'gsb_feature_event_display');
  $icons_settings = array(
    'views_panes:gsb_event-upcoming_events' => 'upcoming-events.png',
    'views_panes:gsb_event-event_calendar_pane' => 'GSB_event_calendar.png',
    'views_panes:gsb_event-event_listing_pane' => 'GSB_event_listing.png',
    'views_panes:gsb_event-frontpage' => 'GSB_event_frontpage.png',
  );
  foreach($icons_settings as $key => $value) {
    if (isset($icons[$key]['icon'])) {
      $icons[$key]['icon'] = $module_path . '/images/' . $value;
    }
  }
}

function gsb_feature_event_display_format_date($raw_value, $object) {
  $date = date('l, F j, Y', strtotime($raw_value));
  return $date;
}
